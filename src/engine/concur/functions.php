<?php

use AwardWallet\Common\DateTimeUtils;
use AwardWallet\Common\Parser\Util\EmailDateHelper;
use AwardWallet\Common\Parser\Util\PriceHelper;
use AwardWallet\Common\Parsing\Html;

class TAccountCheckerConcur extends TAccountChecker
{
    use PriceTools;

    public const TRIP_NUMBER_XPATH = "//div[span[contains(text(), 'Agency Record Locator')]]/text()[last()]";

    private $host = 'www.concursolutions.com';
    private $jsonAuth = true;
    private $csrf;
    private $relayState;
    private $currentItin = 0;

    public function InitBrowser()
    {
        parent::InitBrowser();
        $this->KeepState = true;
        $this->http->FilterHTML = false;
        $this->http->setUserAgent(HttpBrowser::FIREFOX_USER_AGENT);
    }

    public function IsLoggedIn()
    {
        $this->http->RetryCount = 0;
        $this->http->GetURL('https://www.concursolutions.com/profile/PersonalProfile.asp?lang=en-us', [], 20);
        $this->http->RetryCount = 2;

        if ($this->loginSuccessful()) {
            return true;
        }

        return false;
    }

    public function LoadLoginForm()
    {
        $this->http->removeCookies();
        $this->http->GetURL('https://www.concursolutions.com/nui/signin');

        if (!$this->http->ParseForm('frmMain')) {
            return $this->checkErrors();
        }

        $this->csrf = $this->http->FindPreg('/"_csrf":"(.+?)"/');
        $this->relayState = $this->http->FindPreg('/"relayState":"(.+?)"/');

        if (!isset($this->csrf)) {
            $this->jsonAuth = false;
            $this->http->GetURL('https://www.concursolutions.com/default.asp');

            if (!$this->http->ParseForm('frmMain')) {
                return $this->checkErrors();
            }
            $this->http->SetInputValue('userid', $this->AccountFields['Login']);
            $this->http->SetInputValue('password', $this->AccountFields['Pass']);

            return true;
        }// if (!isset($csrf))

        $this->http->setDefaultHeader('Accept', '*/*');
        $this->http->setDefaultHeader('concur-correlationid', $this->http->FindPreg('/"correlationId":"(.+?)"/'));

        $this->sendSensorData();

        $this->http->PostURL('https://www.concursolutions.com/nui/signin/nui-auth/api/authorize', json_encode([
            'attempt'          => 0,
            'userName'         => $this->AccountFields['Login'],
            //            'signedout'        => '',
            'password'         => $this->AccountFields['Pass'],
            'rememberUserName' => true,
            'relayState'       => $this->relayState,
        ]), [
            'Content-Type' => 'application/json',
            'x-csrf-token' => $this->csrf,
            'x-referer'    => 'aHR0cHM6Ly93d3cuY29uY3Vyc29sdXRpb25zLmNvbS8=',
        ]);

        // Enter the authentication code generated by the authenticator app on your mobile device or browser.
        if ($this->http->FindPreg('/"error_description":"Logon Denied. Missing OR bad MFA"/')) {
            $this->State['relayState'] = $this->relayState;
            $this->State['x-csrf-token'] = $this->csrf;
            $this->AskQuestion("Enter the authentication code generated by the authenticator app on your mobile device or browser.", null, "QUestion");

            return false;
        }

        return true;
    }

    public function ProcessStep($step)
    {
        $answer = $this->Answers[$this->Question];
        unset($this->Answers[$this->Question]);
        $headers = [
            'Content-Type' => 'application/json',
            'x-csrf-token' => $this->State['x-csrf-token'],
            'x-referer'    => 'aHR0cHM6Ly93d3cuY29uY3Vyc29sdXRpb25zLmNvbS8=',
        ];
        $data = [
            'attempt'          => 0,
            'userName'         => $this->AccountFields['Login'],
            'totp'             => $answer,
            'password'         => $this->AccountFields['Pass'],
            'rememberUserName' => true,
            'relayState'       => $this->State['relayState'],
        ];
        $this->http->PostURL('https://www.concursolutions.com/nui/signin/nui-auth/api/authorize', json_encode($data), $headers);
        $response = $this->http->JsonLog();

        if (isset($response->error) && $response->error == 'invalid_grant') {
            $this->http->JsonLog();
            $this->AskQuestion($this->Question, "The authentication code you entered is incorrect. Please try again.", 'Question');

            return false;
        }

        return $this->Login();
    }

    public function Login()
    {
        if (!$this->jsonAuth && !$this->http->PostForm()) {
            return $this->checkErrors();
        }

        $response = $this->http->JsonLog();

        $this->checkCredentials();

        if (isset($response->dcRedirect)) {
            $nxdt = $this->http->FindPreg("/nxdt=([^\"]+)/");

            if (!$nxdt) {
                return false;
            }

            $this->http->GetURL($response->dcRedirect);

            $this->host = parse_url($this->http->currentUrl(), PHP_URL_HOST);
            $this->logger->notice("host: $this->host");

            $headers = [
                'Accept'               => '*/*',
                'Content-Type'         => 'application/json',
                'concur-correlationid' => $this->http->FindPreg("/correlationId\":\"([^\"]+)/"),
                'x-csrf-token'         => $this->http->FindPreg("/_csrf\":\"([^\"]+)/"),
                'x-referer'            => 'aHR0cHM6Ly93d3cuY29uY3Vyc29sdXRpb25zLmNvbS8=',
            ];
            $data = [
                'nxdt' => urldecode($nxdt),
            ];
            $this->http->PostURL("https://{$this->host}/nui/signin/nui-auth/api/authorize", json_encode($data), $headers);
            $response = $this->http->JsonLog();
        }
        // Redirect to eu1
        if ($this->http->FindSingleNode('//title[contains(text(), "Redirect")]') && $this->http->ParseForm('frmMain')) {
            $this->http->PostForm();
            $this->host = parse_url($this->http->currentUrl(), PHP_URL_HOST);
            $this->logger->notice("host: $this->host");
        }
        $this->checkCredentials();
        // prevent useless requests
        /*if (!isset($response->success, $response->jwt->token) || $response->success != true)
            return false;
        $data = [
            'redirect' => 'false',
            'lang' => 'en-us',
            'userid' => $this->AccountFields['Login'],
            'JWT' => $response->jwt->token,
            'JWTRefresh' => $response->jwt->refreshToken,
            'JWTExpiresTS' => $response->jwt->JWTExpiresTS,
            'rememberLogin' => 'true',
        ];*/
        $data = [
            'lang'          => 'en-us',
            'code'          => $response->code,
            'no307'         => "Y",
            'redirect_uri'  => 'https://www.concursolutions.com/nui/signin/setsession',
            'correlationId' => $this->http->getDefaultHeader('concur-correlationid') . '-1',
        ];
        $headers = [
            'Accept'       => '*/*',
            'Content-Type' => 'application/x-www-form-urlencoded',
            'x-csrf-token' => $this->csrf,
            'x-referer'    => 'aHR0cHM6Ly93d3cuY29uY3Vyc29sdXRpb25zLmNvbS8=',
        ];
        $this->http->RetryCount = 0;
        $this->http->PostURL("https://{$this->host}/nui/signin/nui-auth/api/setsession", $data, $headers);
        $this->http->RetryCount = 2;
        $response = $this->http->JsonLog();

        // AccountID: 4775497
//        if ((isset($response->error)) && $response->error == "error in nui-auth-api") {
//            $this->host = 'us2.concursolutions.com';
//            $this->http->RetryCount = 0;
//            $this->http->PostURL("https://{$this->host}/nui/signin/nui-auth/api/setsession", $data, $headers);
//            $this->http->RetryCount = 2;
//        }

        if (isset($response->ottcode)) {
            unset($data['correlationId']);
            $data['ottcode'] = $response->ottcode;
            $this->http->RetryCount = 0;
            $this->http->PostURL("https://{$this->host}/nui/signin/nui-auth/api/setsession", $data, $headers);
            $this->http->RetryCount = 2;
            $response = $this->http->JsonLog();
        }

        if (isset($response->targetURL)) {
            $this->http->NormalizeURL($response->targetURL);
            $this->http->GetURL($response->targetURL);
            $this->http->GetURL("https://{$this->host}/profile/PersonalProfile.asp?lang=en-us");

            if (strstr($this->http->currentUrl(), 'https://www.concursolutions.com/common/processing.asp') && $this->http->ParseForm("frmMain")) {
                $this->http->PostForm();
            }
        }

        if ($this->loginSuccessful()) {
            return true;
        }

        return $this->checkErrors();
    }

    public function Parse()
    {
//        $this->host = parse_url($this->http->currentUrl(), PHP_URL_HOST);
//        $this->logger->notice("host: $this->host");
//
//        if ($this->http->ParseForm("frmMain") && $this->host != 'eu1.concursolutions.com'
//            && strstr($this->http->currentUrl(), 'common/processing.asp?goto'))
//            $this->http->PostForm();

        $fname = $this->http->FindSingleNode("//input[@id='FirstName']/@value");
        $lname = $this->http->FindSingleNode("//input[@id='LastName']/@value");
        $this->SetProperty("Name", beautifulName("$fname $lname"));
        // new design
        if (empty($this->Properties['Name']) || trim($this->Properties['Name']) == '') {
            $this->SetProperty("Name", beautifulName($this->http->FindSingleNode("//div[@id = 'cnqr-profile-popup']//div[@class = 'pull-left']/div")));
        }

        if (empty($this->Properties['Name']) || trim($this->Properties['Name']) == '') {
            $this->SetProperty("Name", beautifulName(
                $this->http->FindSingleNode("//div[@class = 'bannergreeting' and contains(text(), 'Welcome,')]/b")
                ?? $this->http->FindPreg("/\"fullName\":\"([^\"]+)/")// AccountID: 4463236
            ));
        }

        foreach ([
            "Employee ID",
            "Manager",
            "Business Unit",
            "Employee Number",
            "Department Name",
            "Department Number", ] as $val) {
            $this->SetProperty(preg_replace("/\s/", "", $val), $this->http->FindSingleNode("//label[text() = '$val']/following::input[1]/@value"));
        }

        if (!empty($this->Properties["Name"])) {
            // AccountID: 1700829
            $this->SetBalanceNA();
        }

        if ($this->ErrorCode == ACCOUNT_ENGINE_ERROR) {
            if ($message = $this->http->FindSingleNode("//div[contains(text(), 'Your password has expired. Please change your password.')]")) {
                throw new CheckException($message, ACCOUNT_PROVIDER_ERROR);
            }
        }// if ($this->ErrorCode == ACCOUNT_ENGINE_ERROR)
    }

    public function ParseItineraries()
    {
        $result = [];
        $this->http->GetURL("https://{$this->host}/travelhome.asp");
        $links = $this->http->FindNodes("//a[contains(@onclick, 'actionOverlib2')]/@onclick");
        $this->logger->debug('Total ' . count($links) . ' trips were found');

        //todo:  WTF?
        /*
        foreach ($links as $idx => $link) {
            if ($tripId = $this->http->FindPreg("/actionOverlib2\(\'[^\']+\'\,\d+\,\'([^\']+)\'/", false, $link)) {
                $this->http->GetURL("https://{$this->host}/travel/popup_itinerary_detail_IT.asp?tripId=".$tripId);
                $result = array_merge($result, $this->ParseTrip());
            }
        }
        */
        // it's work
        $links = $this->http->FindNodes("//div[@id='UpcomingTripsDiv']//a[contains(@onclick, 'tripDefaultAction')]/@onclick");
        $this->logger->debug('Total ' . count($links) . ' trips were found');

        foreach ($links as $link) {
            if ($tripId = $this->http->FindPreg("/tripDefaultAction\(\'[^\']+\'\,\d+\,\'([^\']+)\'/", false, $link)) {
                $this->logger->info('Parse Trip #' . $tripId, ['Header' => 3]);
                $this->http->GetURL("https://{$this->host}/travel/popup_itinerary_detail_IT.asp?tripId=" . $tripId);
                $result = array_merge($result, $this->ParseTrip());
            }
        }

        if (empty($links) && $this->http->FindSingleNode("//div[@id = 'UpcomingTripsDiv']//div[@class = 'no-items-found' and contains(text(),'No records found')]")) {
            return $this->noItinerariesArr();
        }

        return $result;
    }

    private function loginSuccessful()
    {
        $this->logger->notice(__METHOD__);

        if (
            $this->http->FindNodes("//*[text() = 'Log Out'] | //*[text() = 'Sign Out'] | //*[text() = 'Cerrar sesiÃ³n']")
            // AccountID: 3684076
            || $this->http->FindPreg("/\"isLoggedIn\":true,/")
        ) {
            return true;
        }

        return false;
    }

    private function checkErrors()
    {
        $this->logger->notice(__METHOD__);
        // We are performing system maintenance and apologize for the inconvenience.
        if ($message = $this->http->FindSingleNode("//p[contains(text(), 'We are performing system maintenance and apologize for the inconvenience.')]")) {
            throw new CheckException($message, ACCOUNT_PROVIDER_ERROR);
        }
        // Planned maintenance is in progress.
        if ($message = $this->http->FindSingleNode("//p[contains(text(), 'Planned maintenance is in progress.')]")) {
            throw new CheckException($message, ACCOUNT_PROVIDER_ERROR);
        }
        // maintenance
        if ($this->http->currentUrl() == 'http://sitedown.concursolutions.com') {
            throw new CheckException("We are performing system maintenance and apologize for the inconvenience.", ACCOUNT_PROVIDER_ERROR);
        }

        return false;
    }

    private function checkCredentials()
    {
        $this->logger->notice(__METHOD__);

        if (
            $this->http->FindPreg('/"error_description":"Incorrect Credentials. Please Retry"/')
            || $this->http->FindPreg('/"error_description":"Logon Denied. Password expired."/')
            || $this->http->FindPreg('/"error_description":"Incorrect Credentials. Please Retry."/')
        ) {
            throw new CheckException('User name or password is invalid. Please try again. Passwords are case sensitive.', ACCOUNT_INVALID_PASSWORD);
        }
        // Your password has expired. Please change your password.
        if ($this->http->FindPreg('/"error_description":"Logon Denied. Please contact support"/')) {
            throw new CheckException('Your password has expired. Please change your password.', ACCOUNT_INVALID_PASSWORD);
        }
        // Your account has been deactivated. Please contact your administrator.
        if ($this->http->FindPreg('/"error_description":"Account is disabled. Please contact support"/')) {
            throw new CheckException('Your account has been deactivated. Please contact your administrator.', ACCOUNT_INVALID_PASSWORD);
        }
        // Account Locked. Please contact support
        if ($this->http->FindPreg('/"error_description":"Account Locked. Please contact support"/')) {
            throw new CheckException('Your account is locked because there were too many failed login attempts. You can contact your administrator for assistance, or your account may unlock in 24 hours if your company is configured to allow it.', ACCOUNT_INVALID_PASSWORD);
        }
        // Set Up Two-factor Authentication
        if ($this->http->FindPreg('/"error_description":"Logon Denied. Enroll for MFA."/')) {
            throw new CheckException('You must set up two-factor authentication to continue sign-in.', ACCOUNT_PROVIDER_ERROR);
        }
        // User name or password is invalid. Please try again.
        if ($message = $this->http->FindSingleNode("//a[contains(text(), 'User name or password is invalid. Please try again.')]")) {
            throw new CheckException($message, ACCOUNT_INVALID_PASSWORD);
        }
        // Your account has been deactivated. Please contact your administrator.
        if ($message = $this->http->FindSingleNode("//a[contains(text(), 'Your account has been deactivated. Please contact your administrator.')]")) {
            throw new CheckException($message, ACCOUNT_INVALID_PASSWORD);
        }
        // Your account is locked because there were too many failed login attempts.
        if ($message = $this->http->FindSingleNode("//a[contains(text(), 'Your account is locked because there were too many failed login attempts.')]")) {
            throw new CheckException($message, ACCOUNT_LOCKOUT);
        }
    }

    private function firstNode($xpath, $root = null)
    {
        $nodes = $this->http->XPath->query($xpath, $root);

        if ($nodes->length > 0) {
            return $nodes->item(0);
        } else {
            return null;
        }
    }

    private function parseText($xpath, $root = null)
    {
        $nodes = $this->http->FindNodes($xpath, $root);

        return implode('', $nodes);
    }

    private function ParseAir($node)
    {
        $this->logger->notice(__METHOD__);
        $it = ["Kind" => "T"];
        $segment = [];

        $confNo = $this->http->FindSingleNode("descendant::text()[contains(., 'Confirmation:')]", $node, true, '/Confirmation:\s*([A-Z0-9]{6})/');
        $it["RecordLocator"] = $confNo;
        $this->logger->info("[{$this->currentItin}] Parse Air #{$confNo}", ['Header' => 4]);
        $this->currentItin++;
        $it["TripNumber"] = $this->http->FindSingleNode(self::TRIP_NUMBER_XPATH);

        $places = $this->http->FindSingleNode("descendant::div[@class='sgTitle']", $node, true, '/Flight(.+)/');

        if (preg_match("/^(.*)\s\(([A-Z]{3})[^\)]*\)\sto\s(.*)\s\(([A-Z]{3})[^\)]*\)/", $places, $matches)) {
            $segment["DepName"] = trim($matches[1]);
            $segment["DepCode"] = $matches[2];
            $segment["ArrName"] = $matches[3];
            $segment["ArrCode"] = $matches[4];
        }

        $flightNumber = $this->http->FindSingleNode("descendant::div[contains(@id, 'flightSegNum')]", $node);

        if (preg_match("/(.+)\s(\d+)/", $flightNumber, $m)) {
            $segment["FlightNumber"] = $m[2];
            $segment["AirlineName"] = $m[1];
        } else {
            $segment["FlightNumber"] = $flightNumber;
        }

        $date = $this->http->FindSingleNode("ancestor::div[parent::div[contains(@class, 'segdetailsouter')]]/preceding-sibling::div[@class='segdetailsdate'][1]", $node);
        $time = $this->http->FindSingleNode("descendant::text()[contains(., 'Departure:')]", $node, true, "/\d+:\d+ [AP]M/");
        $segment["DepDate"] = strtotime($date . ' ' . $time);
        $time = $this->http->FindSingleNode("descendant::text()[contains(., 'Arrival:')]", $node, true, "/\d+:\d+ [AP]M/");
        $segment["ArrDate"] = strtotime($date . ' ' . $time);

        if ($segment["ArrDate"] > 0 && $segment["ArrDate"] < $segment["DepDate"]) {
            $segment["ArrDate"] += DateTimeUtils::SECONDS_PER_DAY;
        }

        if ($row = $this->firstNode("descendant::div[text()[contains(., 'Departure:')]]", $node)) {
            $rows = $this->http->FindNodes("following-sibling::div", $row);

            foreach ($rows as $text) {
                if ($this->http->FindPreg("/Arrival:/", false, $text)) {
                    break;
                }

                if ($seats = $this->http->FindPreg("/Seat:\s*(\d[\dA-Z]+)/", false, $text)) {
                    $segment["Seats"] = $seats;

                    continue;
                }

                if ($duration = $this->http->FindPreg("/Duration:\s*(.+)/", false, $text)) {
                    $segment["Duration"] = $duration;

                    continue;
                }

                if ($text == 'Nonstop') {
                    $segment["Stops"] = 0;

                    continue;
                }

                if ($departureTerminal = $this->http->FindPreg("/Terminal:\s*(.+)/", false, $text)) {
                    $segment["DepartureTerminal"] = $departureTerminal;

                    continue;
                }
            }// foreach ($rows as $text)
        }// if ($row = $this->firstNode("descendant::div[text()[contains(., 'Departure:')]]", $node))

        if ($row = $this->firstNode("descendant::div[text()[contains(., 'Arrival:')]]", $node)) {
            $rows = $this->http->FindNodes("following-sibling::div", $row);

            foreach ($rows as $text) {
                if ($arrivalTerminal = $this->http->FindPreg("/Terminal:\s*(.+)/", false, $text)) {
                    $segment["ArrivalTerminal"] = $arrivalTerminal;

                    break;
                }
            }// foreach ($rows as $text)
        }// if ($row = $this->firstNode("descendant::div[text()[contains(., 'Arrival:')]]", $node))

        $segment["Aircraft"] = $this->http->FindSingleNode("descendant::text()[contains(., 'Aircraft:')]", $node, true, "/Aircraft:\s*(.+)/");
        $segment["TraveledMiles"] = $this->http->FindSingleNode("descendant::text()[contains(., 'Distance:')]", $node, true, "/Distance:\s*(.+)/");
        $segment["Meal"] = $this->http->FindSingleNode("descendant::text()[contains(., 'Meal:')]", $node, true, "/Meal:\s*(.+)/");

        $cabin = $this->http->FindSingleNode("descendant::text()[contains(., 'Cabin:')]", $node, true, "/Cabin:\s*(.+)/");

        if (!empty($cabin)) {
            if (preg_match("/([^\(]+)\s\(([^\)]+)\)/", $cabin, $m)) {
                $segment["Cabin"] = $m[1];
                $segment["BookingClass"] = $m[2];
            } else {
                $segment["Cabin"] = $cabin;
            }
        }

        $it["Passengers"] = $this->parseText("//*[@class='detailLabel'][text() = 'Passengers:']/parent::*/text()");
        $it["TripSegments"] = [$segment];

        $this->logger->debug('Parsed itinerary:');
        $this->logger->debug(var_export($it, true), ['pre' => true]);

        return $it;
    }

    private function ParseHotel($node)
    {
        $this->logger->notice(__METHOD__);
        $it = ["Kind" => "R"];
        $confNo = $this->http->FindSingleNode("descendant::text()[contains(., 'Confirmation:')]", $node, true, '/Confirmation:\s*(\w+)/');
        $it["ConfirmationNumber"] = $confNo;
        $this->logger->info("[{$this->currentItin}] Parse Hotel #{$confNo}", ['Header' => 4]);
        $this->currentItin++;

        $it["TripNumber"] = $this->http->FindSingleNode(self::TRIP_NUMBER_XPATH);
        $date = $this->http->FindSingleNode("descendant::text()[contains(., 'Checking In:')]", $node, true, "/Checking In:\s*(.+)/");
        $time = $this->http->FindSingleNode(".//div[contains(., 'Checking In:')]/span", $node);
        $this->logger->info("CheckIn time: " . $time);

        if (!empty($time)) {
            $date = $date . ' ' . $time;
        }
        $this->logger->info("CheckInDate: " . $date);

        if (isset($date) && strtotime($date)) {
            $it["CheckInDate"] = strtotime($date);
        }
        $date = $this->http->FindSingleNode("descendant::text()[contains(., 'Checking Out:')]", $node, true, "/Checking Out:\s*(.+)/");
        $time = $this->http->FindSingleNode(".//div[contains(., 'Checking Out:')]/span", $node);
        $this->logger->info("CheckOut time: " . $time);

        if (!empty($time)) {
            $date = $date . ' ' . $time;
        }
        $this->logger->info("CheckOutDate: " . $date);

        if (isset($date) && strtotime($date)) {
            $it["CheckOutDate"] = strtotime($date);
        }

        $it["Rooms"] = trim($this->http->FindSingleNode("descendant::*[contains(text(), 'Room')]/following-sibling::text()[1]", $node, true, null, 0), " ,.");

        if ($it["Rooms"] === '') {
            unset($it["Rooms"]);
        }
        $it["Guests"] = trim($this->http->FindSingleNode("descendant::*[contains(text(), 'Guests')]/following-sibling::text()[1]", $node), " ,.");

        $table = $this->firstNode("table", $node);

        if ($table) {
            $it["HotelName"] = trim($this->http->FindSingleNode("tbody/tr[2] | tr[2]", $table));
            $text = $this->http->XPath->query("tbody/tr[3] | tr[3]", $table);

            if ($text->length > 0) {
                $address = explode("\n", $text->item(0)->nodeValue);

                foreach ($address as $i => $line) {
                    if (Html::cleanXMLValue($line) == "") {
                        unset($address[$i]);
                    } else {
                        $address[$i] = Html::cleanXMLValue($line);
                    }
                }
                $lastLine = end($address);
                // is last line phone?
                $filteredPhone = preg_replace('#[\-\+\s\(\)/]+#', '', $lastLine);

                if (preg_match('#^\d{5,}#', $filteredPhone)) {
                    $it["Phone"] = $lastLine;
                } else {
                    $address[] = $lastLine;
                }
                unset($address[key($address)]);
                $it["Address"] = trim(implode(', ', $address), " ,");
            }// if ($text->length > 0)

            if (!ArrayVal($it, 'Address')) {
                $it['Address'] = $it['HotelName'];
            }
        }// if ($table)
        $cost = $this->http->FindSingleNode("descendant::*[text()[contains(., 'Total Rate:')]]", $node);
        $it["Total"] = PriceHelper::cost($this->http->FindPreg("/[\d\.\,]+/", false, $cost));
        $it["Currency"] = $this->currency($cost);
        $it["Status"] = $this->http->FindSingleNode("descendant::*[contains(text(), 'Status:')]/parent::*/span", $node);
        $it["GuestNames"] = $this->parseText("//*[@class='detailLabel'][text() = 'Passengers:']/parent::*/text()");
        $it["CancellationPolicy"] = $this->http->FindSingleNode("descendant::tr[th[text()[contains(., 'Cancellation Policy')]]]/following-sibling::tr[1]", $node);

        $this->logger->debug('Parsed Itinerary:');
        $this->logger->debug(var_export($it, true), ['pre' => true]);

        return $it;
    }

    private function ParseCar($node)
    {
        $this->logger->notice(__METHOD__);

        $it = ["Kind" => "L"];
        $table = $this->firstNode("div[@class='sgDetail']/table/tbody", $node);

        if (!($pickUpLocation = $this->http->FindSingleNode("descendant::*[contains(text(), 'Pick-up at:')]/parent::*/a", $table))) {
            $this->logger->error('Skip: no pickupLocation for array');

            return [];
        }
        $it["TripNumber"] = $this->http->FindSingleNode(self::TRIP_NUMBER_XPATH);

        $it["RentalCompany"] = $this->http->FindSingleNode("descendant::div[@class='sgTitle']", $node, true, '/(.*)\sat:/');

        $date = $this->http->FindSingleNode("descendant::div[text()[contains(., 'Pick Up:')]]/span", $node);
        $time = $this->http->FindSingleNode("descendant::text()[contains(., 'Pick Up:')]", $node, true, '/Pick Up:\s*(\d+:\d+ [AP]M)/');

        if ($date && $time) {
            $it["PickupDatetime"] = strtotime("$date $time");
        }
        $date = $this->http->FindSingleNode("descendant::div[text()[contains(., 'Return:')]]/span", $node);
        $time = $this->http->FindSingleNode("descendant::text()[contains(., 'Return:')]", $node, true, '/Return:\s*(\d+:\d+ [AP]M)/');

        if ($date && $time) {
            $it["DropoffDatetime"] = EmailDateHelper::parseDateRelative("$date $time", $it['PickupDatetime']);
        }

        $it["PickupLocation"] = $pickUpLocation;

        if (!$it["PickupLocation"]) {
            $it["PickupLocation"] = $this->http->FindSingleNode("descendant::*[contains(text(), 'Pick-up at:')]/parent::*", $node, true, "/at:\s*(\S.+)$/", 1);
        }
        $it["DropoffLocation"] = $this->http->FindSingleNode("descendant::*[contains(text(), 'Returning to:')]/parent::*/a", $table);

        if (!$it["DropoffLocation"]) {
            $it["DropoffLocation"] = $this->http->FindSingleNode("descendant::*[contains(text(), 'Returning to:')]/parent::*", $node, true, "/to:\s*(\S.+)$/");
        }

        if (empty($it["DropoffLocation"])) {
            $it["DropoffLocation"] = $it["PickupLocation"];
        }

        $confNo = $this->http->FindSingleNode("descendant::text()[contains(., 'Confirmation:')]", $node, true, '/Confirmation:\s*([^\s]+)/');

        if (!empty($confNo)) {
            $it["Number"] = $confNo;
        }
        $this->logger->info("[{$this->currentItin}] Parse Car #{$confNo}", ['Header' => 4]);
        $this->currentItin++;

        $it["Status"] = $this->http->FindSingleNode("descendant::*[contains(text(), 'Status:')]/parent::*/span", $node);
        $cost = $this->http->FindSingleNode("descendant::*[text()[contains(., 'Total Rate:')]]", $node);
        $it["TotalCharge"] = PriceHelper::cost($this->http->FindPreg("/[\d\.\,]+/", false, $cost));
        $it["Currency"] = $this->currency($cost);
        $it["RenterName"] = (
            $this->parseText("//*[@class='detailLabel'][text() = 'Passengers:']/parent::*/text()")
            ?: $this->http->FindSingleNode('//span[contains(text(), "Reservation for:")]/ancestor::div[1]/text()[2]')
            ?: null
        );

        $this->logger->debug('Parsed itinerary:');
        $this->logger->debug(var_export($it, true), ['pre' => true]);

        return $it;
    }

    private function ParseTrip()
    {
        $this->logger->notice(__METHOD__);
        $nodes = $this->http->XPath->query("//div[contains(@class, 'airseg')]");
        $this->logger->debug('Total ' . $nodes->length . ' flight segments were found');
        $flights = [];

        for ($i = 0; $i < $nodes->length; $i++) {
            $it = $this->ParseAir($nodes->item($i));

            if (!isset($it["RecordLocator"]) || empty($it["TripSegments"])) {
                continue;
            }

            if (isset($flights[0]) && $flights[0]["RecordLocator"] == $it["RecordLocator"]) {
                $flights[0]['TripSegments'] = array_merge($flights[0]['TripSegments'], $it['TripSegments']);
            } else {
                $flights[] = $it;
            }
        }
        $nodes = $this->http->XPath->query("//div[contains(@class, 'hotel')]");
        $this->logger->debug('Total ' . $nodes->length . ' reservations were found');
        $hotels = [];

        for ($i = 0; $i < $nodes->length; $i++) {
            $it = $this->ParseHotel($nodes->item($i));

            if (isset($it["ConfirmationNumber"])) {
                $hotels[] = $it;
            }
        }
        $nodes = $this->http->XPath->query("//div[contains(@class, 'car')]");
        $this->logger->debug('Total ' . $nodes->length . ' rentals were found');
        $cars = [];

        for ($i = 0; $i < $nodes->length; $i++) {
            $it = $this->ParseCar($nodes->item($i));

            if (isset($it["Number"])) {
                $cars[] = $it;
            }
        }

        return array_merge($flights, $hotels, $cars);
    }

    private function sendSensorData()
    {
        $this->logger->notice(__METHOD__);
        $sensorDataUrl = $this->http->FindPreg("#_cf\.push\(\['_setAu', '(/.+?)'\]\);#")
            ?? $this->http->FindNodes('//script[last()]/@src');

        if (is_array($sensorDataUrl)) {
            $sensorDataUrl = array_pop($sensorDataUrl);
            $this->logger->debug("sensor_data URL: $sensorDataUrl");
        }

        if (empty($sensorDataUrl)) {
            $this->logger->error("sensor_data URL not found");

            return $this->checkErrors();
        }
        $this->http->NormalizeURL($sensorDataUrl);

        /*
        $sensorData = [
            "7a74G7m23Vrp0o5c9112511.66-1,2,-94,-100,Mozilla/5.0 (Macintosh; Intel Mac OS X 11_0_0) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/86.0.4240.198 Safari/537.36,uaend,12147,20030107,en-US,Gecko,3,0,0,0,395094,6315929,1536,872,1536,960,1536,407,1536,,cpen:0,i1:0,dm:0,cwen:0,non:1,opc:0,fc:0,sc:0,wrc:1,isc:0,vib:1,bat:1,x11:0,x12:1,8919,0.944802067472,802883157964,0,loc:-1,2,-94,-101,do_en,dm_en,t_en-1,2,-94,-105,0,-1,0,0,1469,864,0;1,-1,0,0,-1,883,0;-1,2,-94,-102,0,-1,0,0,1469,864,0;1,-1,0,0,-1,883,0;-1,2,-94,-108,-1,2,-94,-110,-1,2,-94,-117,-1,2,-94,-111,-1,2,-94,-109,-1,2,-94,-114,-1,2,-94,-103,-1,2,-94,-112,https://www.concursolutions.com/nui/signin-1,2,-94,-115,1,32,32,0,0,0,0,2,0,1605766315928,-999999,17178,0,0,2863,0,0,3,0,0,35BCA32B9D3B740BA122E6B2477AEA46~-1~YAAQvx/JF9QpStd1AQAAgnoh3wQmagmiEF9La2DynVvycyEI2+DnisnlOTz9i2qlNcDr5eAspXA6pHlGf/YuVx6vS7Vb78VLeQCiyMcNmnN5RpDOp9PTUYEjaeEPK9uJBOXX9x9at52RwRkQCVJNpo5j0edcQs9wXf4LF/z6Bsa3ueCN1t3qw/EWpaSrWSwuiRG9BDXFRCsV573krVO3IJBw14ZscS/P3WpCTh2TlTXQjmt3xcrPUcyat3WJl7wpyCfMiQHrX6AFIofFRblLLfx1ZjgNuOW0fQ18FC484NYon+1wK1pS/TCHMw0+816yvCLj~-1~-1~-1,30402,-1,-1,30261693,PiZtE,64367,35-1,2,-94,-106,0,0-1,2,-94,-119,-1-1,2,-94,-122,0,0,0,0,1,0,0-1,2,-94,-123,-1,2,-94,-124,-1,2,-94,-126,-1,2,-94,-127,8-1,2,-94,-70,-1-1,2,-94,-80,94-1,2,-94,-116,18947862-1,2,-94,-118,82014-1,2,-94,-129,-1,2,-94,-121,;5;-1;0",
        ];

        $secondSensorData = [
            "7a74G7m23Vrp0o5c9112511.66-1,2,-94,-100,Mozilla/5.0 (Macintosh; Intel Mac OS X 11_0_0) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/86.0.4240.198 Safari/537.36,uaend,12147,20030107,en-US,Gecko,3,0,0,0,395094,6315929,1536,872,1536,960,1536,407,1536,,cpen:0,i1:0,dm:0,cwen:0,non:1,opc:0,fc:0,sc:0,wrc:1,isc:0,vib:1,bat:1,x11:0,x12:1,8919,0.630872682315,802883157964,0,loc:-1,2,-94,-101,do_en,dm_en,t_en-1,2,-94,-105,0,-1,0,0,1469,864,0;1,-1,0,0,-1,883,0;-1,2,-94,-102,0,-1,0,0,1469,864,0;1,-1,0,0,-1,883,0;-1,2,-94,-108,-1,2,-94,-110,-1,2,-94,-117,-1,2,-94,-111,-1,2,-94,-109,-1,2,-94,-114,-1,2,-94,-103,-1,2,-94,-112,https://www.concursolutions.com/nui/signin-1,2,-94,-115,1,32,32,0,0,0,0,1295,0,1605766315928,72,17178,0,0,2863,0,0,1296,0,0,35BCA32B9D3B740BA122E6B2477AEA46~-1~YAAQvx/JF+spStd1AQAAAoEh3wT/6+7PVKeVtkWnNa9PVd+WPxOzaFKLB5WIt1eWDnS5+Ubh1bJjQvZ/IKHxyk9VUKR7LZevrnLDJMQLxfSumwMWgDXNchXu6rMMFc86cW3o9Ow4lFMhfOfkRNnYJYWKLI/nrzcNvkLzsWRYTK5jf0nzQDI+wcRnCWC2FPMlALpgyei2v2Qt4u/kyPGBHrikp0YZm1y7c6pxFV9H2/MylnFAah01X2kn08i/NADMfSzplnY3x0D7RdolwiIKPgYBds5neCBcwiwK0nScfnaq2EZcIdOQUEk9HtF/ncQ2zYpcOUH4Pi8p5vyqQXQDPvE=~-1~-1~-1,32363,970,-67093513,30261693,PiZtE,62677,60-1,2,-94,-106,9,1-1,2,-94,-119,28,31,143,33,48,64,36,30,29,27,6,1283,1248,428,-1,2,-94,-122,0,0,0,0,1,0,0-1,2,-94,-123,-1,2,-94,-124,-1,2,-94,-126,-1,2,-94,-127,11321144241322243122-1,2,-94,-70,-36060876;-1849314799;dis;,7,8;true;true;true;-300;true;30;30;true;false;-1-1,2,-94,-80,5578-1,2,-94,-116,18947862-1,2,-94,-118,87632-1,2,-94,-129,d559b1055fc4a403e55602ada6c4e235ca4ed85f566b800fbd306cf7d958dea4,2,0,,,,0-1,2,-94,-121,;12;9;0",
        ];

        if (count($sensorData) != count($secondSensorData)) {
            $this->logger->error("wrong sensor data values");

            return null;
        }
        $key = array_rand($sensorData);
        $this->logger->notice("key: {$key}");
        */

        $sensorData = '2;3682356;3158327;8,0,0,0,2,0;X$)rBp>!]RGI6~lLHLNK7L=-^CXTs|&N%6mnAQtXBG8.%*@g6T_`q}{Vq kRd2%ofH}64f=2K-qNSD77(!x|SD<lcNy* oymqCZTT*`R<WAZWiSr&^o-irVDm!vl82gde@S>Q3xsD7gNr1qkI!k+gMTQDiF`6Zru|8lN8|LchK[#N(#Vx.^tdS`n{*kR&;fjzdP@}dOc~A?en2/5,`K8/t4D#Y/RBV~,RGx&yjhxz9Hr%LY]T9_0*pALyI+hDn>-umu;=x?kmfcq+Ha}9`%iX/6CsB(-NrFn42$a ++@E).e|Nk~ypj(({mxN#fQke?g8?6zW,rmDUsRqAc S-X:OMy6#^Q.x(w9;;E~eRMfY)HU`)BomC`GJ]5+N }^pfO*e3D+j%&IdAnYZq|ZU4T<K*Ch_jI-(kV1t$80o[PZ(nCzL=e16SA6wwHv`TTPA./cI) aSy,7Js2cDBTT4>!t=R7rmg9bcOX6j*^I7ZwX.hYKS!Iv?b-Ik5!,nb_Yu,jD:W`?qAZdnl@K&Wa2]~# @ndOELX`ognPTyDKMJO{]QzU ,a&%.XGh1S )|HOc_h`T%^dl4YG+,~~pz)Ec~*(/ZVhbdq0O|iRP)_E8DbU3fTVXUN-)JSW6imiu/Q*43D<JxYoyY$,xXv&z<{Gj8=T:K9l1Bp6Xk.17dKmQh2609:L85fV1p+F2ey(GW7JTRR|rS4WcvAA,AApl$#|gOi ybwuIX_i<Bm&6(f5W8#(*>Rw]_=o8%<d^*!f<_5g:$D>MF2f3$f%wjXv$POi?=u-*}39R~c73]@Xcl[c~MI^i(<iILO4cP~P]yj|b2yF,QAQz{vFnol_5^vLo<yiYS:^mp-*CoK(wJ/Euv~s8:|Fq.V=S]U]]Wf&x Gw^/#fJ0}6CKPd3Kuo)o{>*a?)*PsuO/d4oLFe+#`SIXC5k9r4L=Tb.>[HA>%akxb+GxbAzkQ10;O8)eOy3}TEgWxKXoV~(iM0sdl[]EGI]a,tA<3o@ ME|HQh):0oDZn~kiq7%JV:PZUDJh~G)gKAB|DyBa!Tf:%g[E[Pke7?1XwG#?H<o7]2cO}3HequkaG@8h`PW{gJ9)510t!e3_* jk?3P{{{Suieb2cP+_Q&/]F;9s7YnbW]y]:|E{!^a-1ykPWW~|3+/X1<T|~W+%w:O-m[>tSG]@<5OX~|Eft<vL)=LPYG;BvdOUQ<Wna9d5>2U5>@s#A8S u~g*XD>X|mfvghF-Ea P/Tdj>!5G^o{-]bykJV;IYuv317|U{2Ovu,UjLZBIK6:u25P:!/XRIy!@8K-{>gTFU@|UQ{-R+6LA>,+hYlGGAb&E~r>7K|{q8=t8%D6Od`PNOMH00= yxOb$BQD4i;G&LpM M1l<y8MuY)TMAet@8HA {JD4^x%Fe!jJ%=nvZvFTP(gg`.//![ Ul]69c6HFt@.WP zW?f/:<NlkW%EQK~n%C[gl]2DI E/qn?kJJ8ej5q&za5E]h=ehp/6H#tz>xv9j/_^/:[`SjA(FQ(F`#;3X~Ihi7&>]b*}c}f5UOmZpp7a/.7H&L?!;<c}9${hY0to+qVfQK9h6HjJYgzP3~vka<|6NBEf~cIMBDOQ.l1|5>.]u/|VS<:nX1(CPRV#;;y(v=-D994|:#$m6f,|qP+QVB/S~z(C/{h^Gqv8)=/+pKlV!Dxu#XS%4r&V,qv1A=b-@Dc%V/=j5(4GtL5^vyViDjjFMi]amE,#bY.LA`XcM/n!opH5g3?A<?P1;Gf@aAcB^~|oH&3VtPz1d*~4+6L;F=!!O^Fu$Sl&.?uE+Kv{=o&[, e%b9ZVS6[95`EgOYCq@|!FcC3e[?0o!-=~Bn|(iO7LXhTQv$5clDnWyN51h_l_5lzFUax1OXsg2~B5}:A<3P?FJbEzK<~9SF h$M*z)RadzbnBhlIaz_?cCbtdef/kR^b<rv~K!L<t CvZzs9r;0IUDj),CQljo}]}l!JXbdR2eA=~OXke|+<oT_W[egLqzG,x4{[3P9W7?!Uu^S2R{T >J+UBfF<Dq:I^ 3S*8Ag=^AHal5$xjrm@mj5^>jyX]bqB3GFzJwQVp[X^yV[8mjecT3{YJKjh#i-%lLkzZH`s(yucP|gXKRtaK0tb(;X*<U6eL,+^*HVH2/yC.Z.){934)-nZ9RF9cs=Iv^fw4hWv7 e:eP:]J_L`Tq7)Ut0!InI85ohXNJf@`{d@UnKKJjh{7G49d1==i4*f_URJ=Sz:istt3~kuzEDJ4}vnm!0#d1N|oSlZ:G5iBQe>K,Z+%uk*yE9oyG(sQ o]tfuw|G!,n*FpQV_w+HV0:1R`V%:I.d>v^bqOEq&Mkl_N-`IjqcY(>cbzU=e|O3?7Fipk~%-VGd%vhcj7UbI{:jcrhVn9y.~r&3R8>sCj[i=%IHEm)j6`F_knqd]Y@z2APk2Dc`o*W}@F0,u1R:c<cBLgd]35p6QS^ZXs7PZMGB>;5UwNAm)meu4OIM#JGAZ>FY$?eXT*3`sY1^{!1e?26Lc#-1nCFD5%I_>X2A]h<Etz Sn{3#PN#8,^cw-L)5YBLhDoGXzE6mP[u?cP*Z%S, LT8:wkn<NZ0XIwz#ADM)v+D~t6ptZb5)^`MTI)i[$<-YEgNqzgjRdZeIyseXGU3*!ETr%X_l@yc2{]=l@}vZNx*8RN(-)4,tZ=$!bhy9la-o_B)+FNq^]w<&ki1.]eb^C$R|R1$E3`L@7og.~@k^]+|9xz{P+:5A0N]he_2S1xmQ^k<lWwILA!LqA%IMQX[k/a+DYVQXAu';

        $sensorDataHeaders = [
            "Accept"        => "*/*",
            "Content-type"  => "application/json",
        ];
        $this->http->RetryCount = 0;
        $this->http->PostURL($sensorDataUrl, json_encode(['sensor_data' => /*$sensorData[$key]*/ $sensorData]), $sensorDataHeaders);
        $this->http->JsonLog();

        $sensorData = 'ap=true&bt=0&fonts=null&fh=null&timing=%7B%221%22%3A27%2C%222%22%3A148%2C%223%22%3A439%2C%224%22%3A652%2C%22profile%22%3A%7B%22bp%22%3A1%2C%22sr%22%3A3%2C%22dp%22%3A0%2C%22lt%22%3A0%2C%22ps%22%3A0%2C%22cv%22%3A21%2C%22fp%22%3A0%2C%22sp%22%3A0%2C%22br%22%3A0%2C%22ieps%22%3A0%2C%22av%22%3A0%2C%22z1%22%3A1%2C%22jsv%22%3A1%2C%22nav%22%3A0%2C%22nap%22%3A0%2C%22crc%22%3A0%2C%22z2%22%3A0%2C%22z3%22%3A1%2C%22z4%22%3A0%7D%2C%22main%22%3A2639%2C%22compute%22%3A27%2C%22send%22%3A652%7D&bp=2087755996%2C1953464915%2C591862434%2C325835597%2C1068473606%2C-1382186647%2C-365096851%2C-1979186206%2C-108039040%2C-1906852049&sr=%7B%22inner%22%3A%5B1512%2C703%5D%2C%22outer%22%3A%5B1512%2C861%5D%2C%22screen%22%3A%5B0%2C38%5D%2C%22pageOffset%22%3A%5B0%2C0%5D%2C%22avail%22%3A%5B1512%2C861%5D%2C%22size%22%3A%5B1512%2C982%5D%2C%22client%22%3A%5B1512%2C703%5D%2C%22colorDepth%22%3A30%2C%22pixelDepth%22%3A30%7D&dp=%7B%22XDomainRequest%22%3A0%2C%22createPopup%22%3A0%2C%22removeEventListener%22%3A1%2C%22globalStorage%22%3A0%2C%22openDatabase%22%3A0%2C%22indexedDB%22%3A1%2C%22attachEvent%22%3A0%2C%22ActiveXObject%22%3A0%2C%22dispatchEvent%22%3A1%2C%22addBehavior%22%3A0%2C%22addEventListener%22%3A1%2C%22detachEvent%22%3A0%2C%22fireEvent%22%3A0%2C%22MutationObserver%22%3A1%2C%22HTMLMenuItemElement%22%3A0%2C%22Int8Array%22%3A1%2C%22postMessage%22%3A1%2C%22querySelector%22%3A1%2C%22getElementsByClassName%22%3A1%2C%22images%22%3A1%2C%22compatMode%22%3A%22CSS1Compat%22%2C%22documentMode%22%3A0%2C%22all%22%3A1%2C%22now%22%3A1%2C%22contextMenu%22%3A0%7D&lt=1695839560238%2B5&ps=true%2Ctrue&cv=ae87b430412e15f5c9ef67133125df87c5cf9c62&fp=false&sp=false&br=Firefox&ieps=false&av=false&z=%7B%22a%22%3A1302863914%2C%22b%22%3A1%2C%22c%22%3A0%7D&zh=&jsv=1.5&nav=%7B%22userAgent%22%3A%22' . urlencode($this->http->userAgent) . '%22%2C%22appName%22%3A%22Netscape%22%2C%22appCodeName%22%3A%22Mozilla%22%2C%22appVersion%22%3A%225.0%20(Macintosh)%22%2C%22appMinorVersion%22%3A0%2C%22product%22%3A%22Gecko%22%2C%22productSub%22%3A%2220100101%22%2C%22vendor%22%3A%22%22%2C%22vendorSub%22%3A%22%22%2C%22buildID%22%3A%2220181001000000%22%2C%22platform%22%3A%22MacIntel%22%2C%22oscpu%22%3A%22Intel%20Mac%20OS%20X%2010.15%22%2C%22hardwareConcurrency%22%3A10%2C%22language%22%3A%22en-US%22%2C%22languages%22%3A%5B%22en-US%22%2C%22en%22%5D%2C%22systemLanguage%22%3A0%2C%22userLanguage%22%3A0%2C%22doNotTrack%22%3A%22unspecified%22%2C%22msDoNotTrack%22%3A0%2C%22cookieEnabled%22%3Atrue%2C%22geolocation%22%3A1%2C%22vibrate%22%3A1%2C%22maxTouchPoints%22%3A0%2C%22webdriver%22%3Afalse%2C%22plugins%22%3A%5B%22PDF%20Viewer%22%2C%22Chrome%20PDF%20Viewer%22%2C%22Chromium%20PDF%20Viewer%22%2C%22Microsoft%20Edge%20PDF%20Viewer%22%2C%22WebKit%20built-in%20PDF%22%5D%7D&crc=%7B%22window.chrome%22%3A%22-not-existent%22%7D&t=9f348eb3700a4afa6396564ca9938770aa347f52&u=a1b653915ee15a9ca6fa3cda02cdf316&nap=00013333331333333333';

        $this->http->PostURL('https://www.concursolutions.com/akam/13/pixel_4da823a2', $sensorData, ['Accept' => '*/*']);
        $this->http->RetryCount = 2;
        $this->http->JsonLog();
        /*
        sleep(1);
        $this->http->PostURL($sensorDataUrl, json_encode(['sensor_data' => $secondSensorData[$key]]), $sensorDataHeaders);
        $this->http->RetryCount = 2;
        $this->http->JsonLog();
        sleep(1);

        return $key;
        */
        return null;
    }
}
