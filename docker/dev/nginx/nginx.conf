# X-Symfony-Env header should be preferred over SITE_STATE cookie
# SYMFONY_ENV will be replaced in docker/nginx-dev-entrypoint.sh
map "$cookie_SITE_STATE:$http_x_symfony_env:%SYMFONY_ENV%" $php_script_name {
    default "app_dev.php";
    ~^.*:(prod|staging):.*$ "app.php";
    ~^(prod|staging):.*:.*$ "app.php";
    ~^dev:.*:.*$ "app_dev.php";
    ~^.*:dev:.*$ "app_dev.php";
    ~^.*:.*:(prod|staging)$ "app.php";
}

map "$cookie_SITE_STATE:$http_x_symfony_env:%SYMFONY_ENV%" $symfony_env {
    default "dev";
    ~^.*:(.+):.*$ $1;
    ~^(.+):.*:.*$ $1;
    ~^.*:.*:(.+)$ $1;
}

resolver 127.0.0.11 ipv6=off;

log_format awardwallet '$http_x_forwarded_for $host $remote_user [$time_local] '
                    '"$request" $status $body_bytes_sent '
                    '"$http_referer" "$http_user_agent" "$sent_http_x_sessionid" "$sent_http_x_aw_userid" '
                    '"$sent_http_x_phptime" "$request_time" "$sent_http_x_requestid"';

upstream centrifugo {
    server centrifugo:80;
}

server {
    large_client_header_buffers 4 32k;

    client_max_body_size 100M;
    client_body_buffer_size 100M;

    add_header X-Xss-Protection "1; mode=block" always;

    error_log  /dev/stderr notice;
    access_log /dev/stdout;

#    access_log syslog:server=fluent:5140,facility=local7,tag=nginx,severity=info awardwallet;
#    error_log syslog:server=fluent:5141,facility=local7,tag=nginx,severity=error;

    root /www/awardwallet/src;

    location ~ ^/lib/ {
        root /www/awardwallet/vendor/awardwallet;
    }

    if ($uri ~ ^/webPush/chrome/manifest.json) {
        set $symfony_env "prod";
        set $symfony_debug "0";
        set $php_script_name "app.php";
    }

    if ($host ~ beta) {
      rewrite ^(.*)$ http://awardwallet.docker$1 permanent;
    }

    set $rwold "";
    if ($http_user_agent ~* "MSIE [4-9]") {
            set $rwold '1';
    }
    if ($uri != '/old-browser.html') {
            set $rwold "${rwold}2";
    }
    if ($uri !~ '\.(ico|pdf|flv|jpg|jpeg|png|gif|js|css|swf|woff|ttf)') {
            set $rwold "${rwold}3";
    }
    if ($rwold = '123') {
            rewrite ^.*$ /old-browser.html last;
    }

    location /old-browser.html {
        add_header Cache-Control "max-age=0, must-revalidate, no-cache, no-store, post-check=0, pre-check=0, private";
        add_header Pragma "no-cache";                    
    }

    location /forum {
            rewrite ^.*$ / redirect;
    }

    location ~ ^/(engine/\w+/extension\.js|api/?$) {
        try_files no_match @symfony;
    }

    location ~ \.(css|js|png|jpeg|gif)$ {
        try_files $uri =404;
        add_header Cache-Control "max-age=0, must-revalidate, no-cache, no-store, post-check=0, pre-check=0, private";
        add_header Pragma "no-cache";
    }

    location ~ /m/api {
        try_files /dev/null @symfony;
    }

    location ~ /m/ {
        try_files $uri $uri/ /m/index.html;
    }

    location / {
        try_files $uri @symfony;
    }

    location ~ ^/r/([^/]+)/? {
          try_files no_match /rating/reviews.php?Provider=$1;
    }

    location ~ /(extension\-response|extension\-save\-login\-id) {
        # remove XDEBUG_SESSION cookie to allow parallel requests
        fastcgi_pass_request_headers off;
        fastcgi_pass_header Content-Type;
        fastcgi_pass_header Content-Length;
        fastcgi_pass_header Connection;
        fastcgi_pass_header Host;
        include fastcgi-symfony.conf;
    }

    location /logs/ {
        autoindex on;
    }

    location @symfony {
        include fastcgi-symfony.conf;
    }

    location ~ /(images|bundles|b|js|m|css)/.*\.php$ {
        return 403;
    }

    location ~\.php$ {
        try_files /dev/null @symfony;
    }

    location ~ /connection/(websocket|http_stream|sse|emulation)$ {
      proxy_pass          http://centrifugo;
      proxy_http_version  1.1;
      proxy_redirect      default;
      proxy_set_header    Upgrade $http_upgrade;
      proxy_set_header    Connection "upgrade";
      proxy_set_header    Host $host;
      proxy_set_header    X-Real-IP $remote_addr;
      proxy_set_header    X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header    X-Forwarded-Host $server_name;
    }

}
